# bag_converter

## Overview

`bag_converter` is a tool for converting rosbag2 files containing Nebula packets to PointCloud2 messages. The tool decodes Nebula packet topics (`/nebula_packets`) and converts them to point cloud topics (`/nebula_points`).

## Install
```shell
# clone repository
git clone https://github.com/tier4/bag_converter.git

# clone dependencies
cd bag_converter
vcs import src < repos.yaml

# build
cd docker
./build.sh

# clean build
./build.sh --no-cache
```


## Usage
```shell
./bag_converter <path-to-intput-mcap> <path-to-output-mcap>
```

## Message Types

### Input: NebulaPackets

The input bag file contains `nebula_msgs::msg::NebulaPackets` messages on topics ending with `/nebula_packets`. These messages contain raw packet data from Nebula LiDAR sensors.

#### Properties

- **`header.stamp`**: Timestamp in nanoseconds generated by the system clock when the packet was received (UTC)
- **`packets`**: Array of `nebula_msgs::msg::NebulaPacket` containing raw packet data from the LiDAR

### Output: PointCloud2

The output bag file contains `sensor_msgs::msg::PointCloud2` messages on topics ending with `/nebula_points`. The PointCloud2 messages have the following structure:

#### Fields

The PointCloud2 messages contain the following fields:

- `x` (float32): X coordinate in meters
- `y` (float32): Y coordinate in meters
- `z` (float32): Z coordinate in meters
- `intensity` (float32): Intensity value
- `t_us` (uint32): Relative timestamp in microseconds from the scan start time

#### Timestamps

All timestamps in PointCloud2 messages are based on UTC (Coordinated Universal Time).

- **`header.stamp`**: Absolute timestamp representing the scan start time in UTC. This timestamp is generated by the LiDAR and represents when the scan began.
- **`t_us` field**: Relative timestamp in microseconds from the scan start time (`header.stamp`)

The absolute timestamp for each point (in nanoseconds, UTC) can be calculated as:
```
absolute_timestamp_ns = (header.stamp.sec * 1,000,000,000 + header.stamp.nanosec) + (t_us * 1,000) nanoseconds
```

## Parsing PointCloud2 Messages

The repository includes a Python script `scripts/decode_pointcloud2.py` that demonstrates how to parse PointCloud2 messages from rosbag2 files.

### Basic Usage

```shell
# Decode all PointCloud2 topics in a bag file
python scripts/decode_pointcloud2.py <path-to-bag>

# Decode a specific topic
python scripts/decode_pointcloud2.py <path-to-bag> --topic /sensing/lidar/front/nebula_points

# Limit the number of points displayed per message
python scripts/decode_pointcloud2.py <path-to-bag> --max-points-to-show 10

# Add delay between messages (in seconds)
python scripts/decode_pointcloud2.py <path-to-bag> --delay 0.1
```

### Example Output

The following image shows example output from `decode_pointcloud2.py`:

<img src="media/decode_pointcloud2_output.png" alt="decode_pointcloud2.py output" width="800">

**Note:** The "Available fields" shown in the output are the fields embedded in the PointCloud2 message. The "stamp" value displayed for each point is calculated from `header.stamp` and `t_us` field, representing the absolute timestamp of that point.