#!/bin/sh

# Check if Docker is installed
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: Docker is not installed. Please install Docker from https://docs.docker.com/engine/install/"
    exit 1
fi

# Check if bag_converter:latest image exists
if ! docker image inspect bag_converter:latest >/dev/null 2>&1; then
    echo "Error: Docker image 'bag_converter:latest' not found. Please build it first by running: cd bag_converter/docker && ./build.sh"
    exit 1
fi

# If we have at least 2 arguments, treat first two as input/output paths for Docker volume mounting
# Otherwise, pass all arguments directly to the binary
if [ $# -ge 2 ]; then
    INPUT_PATH="$1"
    OUTPUT_PATH="$2"
    
    # Get absolute paths (use -m for output to allow non-existent paths)
    INPUT_ABS=$(realpath "$INPUT_PATH" 2>/dev/null || echo "$INPUT_PATH")
    OUTPUT_ABS=$(realpath -m "$OUTPUT_PATH" 2>/dev/null || echo "$OUTPUT_PATH")
    
    # Get directory paths for Docker volume mounting
    INPUT_DIR=$(dirname "$INPUT_ABS")
    OUTPUT_DIR=$(dirname "$OUTPUT_ABS")
    INPUT_FILE=$(basename "$INPUT_ABS")
    OUTPUT_FILE=$(basename "$OUTPUT_ABS")
    
    # Shift to get remaining arguments (options)
    shift 2
    
    # Run the bag converter using Docker with volume mounts
    # Replace input and output paths with Docker container paths
    docker run -it --rm \
        -v "$INPUT_DIR":/input \
        -v "$OUTPUT_DIR":/output \
        -e INPUT_FILE="$INPUT_FILE" \
        -e OUTPUT_FILE="$OUTPUT_FILE" \
        bag_converter:latest \
        sh -c 'ros2 run bag_converter bag_converter "/input/$INPUT_FILE" "/output/$OUTPUT_FILE" "$@"' -- "$@"
else
    # Pass all arguments directly to the binary (let it handle errors)
    docker run -it --rm \
        bag_converter:latest \
        ros2 run bag_converter bag_converter "$@"
fi
