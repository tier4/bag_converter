#!/bin/sh

# Docker image tag
IMAGE_TAG="latest"

# Check if Docker is installed
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: Docker is not installed. Please install Docker from https://docs.docker.com/engine/install/"
    exit 1
fi

# Check if bag_converter:${IMAGE_TAG} image exists
if ! docker image inspect bag_converter:${IMAGE_TAG} >/dev/null 2>&1; then
    echo "Error: Docker image 'bag_converter:${IMAGE_TAG}' not found. Please build it first by running: cd bag_converter/docker && ./build.sh"
    exit 1
fi

# Use -it when running in a TTY, -i otherwise
DOCKER_FLAGS="-i"
if [ -t 0 ]; then
    DOCKER_FLAGS="-it"
fi

# Batch mode: mount input/output as directories
if [ "$1" = "--batch" ] && [ $# -ge 3 ]; then
    shift # consume --batch
    INPUT_ABS=$(realpath "$1")
    OUTPUT_ABS=$(realpath -m "$2")
    shift 2

    # Create output directory on host so Docker doesn't create it as root
    mkdir -p "$OUTPUT_ABS"

    docker run $DOCKER_FLAGS --rm \
        -v "$INPUT_ABS":/input:ro \
        -v "$OUTPUT_ABS":/output \
        bag_converter:${IMAGE_TAG} \
        ros2 run bag_converter bag_converter --batch /input /output "$@"

# Single file mode: mount input/output parent directories
elif [ $# -ge 2 ]; then
    INPUT_PATH="$1"
    OUTPUT_PATH="$2"

    # Get absolute paths (use -m for output to allow non-existent paths)
    INPUT_ABS=$(realpath "$INPUT_PATH" 2>/dev/null || echo "$INPUT_PATH")
    OUTPUT_ABS=$(realpath -m "$OUTPUT_PATH" 2>/dev/null || echo "$OUTPUT_PATH")

    # Get directory paths for Docker volume mounting
    INPUT_DIR=$(dirname "$INPUT_ABS")
    OUTPUT_DIR=$(dirname "$OUTPUT_ABS")
    INPUT_FILE=$(basename "$INPUT_ABS")
    OUTPUT_FILE=$(basename "$OUTPUT_ABS")

    # Shift to get remaining arguments (options)
    shift 2

    # Run the bag converter using Docker with volume mounts
    # Replace input and output paths with Docker container paths
    docker run $DOCKER_FLAGS --rm \
        -v "$INPUT_DIR":/input \
        -v "$OUTPUT_DIR":/output \
        -e INPUT_FILE="$INPUT_FILE" \
        -e OUTPUT_FILE="$OUTPUT_FILE" \
        bag_converter:${IMAGE_TAG} \
        sh -c 'ros2 run bag_converter bag_converter "/input/$INPUT_FILE" "/output/$OUTPUT_FILE" "$@"' -- "$@"
else
    # Pass all arguments directly to the binary (let it handle errors)
    docker run $DOCKER_FLAGS --rm \
        bag_converter:${IMAGE_TAG} \
        ros2 run bag_converter bag_converter "$@"
fi
